



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="./img/favicon.ico">
      <meta name="generator" content="mkdocs-0.17.1, mkdocs-material-2.6.2">
    
    
      
        <title>Granite Manual</title>
      
    
    
      <link rel="stylesheet" href="./assets/stylesheets/application.9b572555.css">
      
        <link rel="stylesheet" href="./assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="./assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#granite-framework" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="Granite Manual" class="md-header-nav__button md-logo">
          
            <img src="./img/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Granite Manual
              </span>
              <span class="md-header-nav__topic">
                Home
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/toptal/granite/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="./img/logo.png" width="24" height="24">
      
    </span>
    Granite Manual
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/toptal/granite/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Home
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-problems-it-solves" title="What problems it solves?" class="md-nav__link">
    What problems it solves?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#business-actions" title="Business actions" class="md-nav__link">
    Business actions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hello-world" title="Hello world" class="md-nav__link">
    Hello world
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performer" title="Performer" class="md-nav__link">
    Performer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attributes" title="Attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#represents" title="Represents" class="md-nav__link">
    Represents
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associations" title="Associations" class="md-nav__link">
    Associations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nestedactions" title="NestedActions" class="md-nav__link">
    NestedActions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subject" title="Subject" class="md-nav__link">
    Subject
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#policies-preconditions-validations" title="Policies, preconditions, validations" class="md-nav__link">
    Policies, preconditions, validations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#policies" title="Policies" class="md-nav__link">
    Policies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preconditions" title="Preconditions" class="md-nav__link">
    Preconditions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validations" title="Validations" class="md-nav__link">
    Validations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context-validations" title="Context validations" class="md-nav__link">
    Context validations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exceptions-handling" title="Exceptions handling" class="md-nav__link">
    Exceptions handling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#i18n" title="I18n" class="md-nav__link">
    I18n
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generator" title="Generator" class="md-nav__link">
    Generator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="projectors/" title="Projectors" class="md-nav__link">
      Projectors
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="testing/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="tutorial/" title="Tutorial" class="md-nav__link">
      Tutorial
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-problems-it-solves" title="What problems it solves?" class="md-nav__link">
    What problems it solves?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#business-actions" title="Business actions" class="md-nav__link">
    Business actions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hello-world" title="Hello world" class="md-nav__link">
    Hello world
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performer" title="Performer" class="md-nav__link">
    Performer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attributes" title="Attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#represents" title="Represents" class="md-nav__link">
    Represents
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associations" title="Associations" class="md-nav__link">
    Associations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nestedactions" title="NestedActions" class="md-nav__link">
    NestedActions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subject" title="Subject" class="md-nav__link">
    Subject
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#policies-preconditions-validations" title="Policies, preconditions, validations" class="md-nav__link">
    Policies, preconditions, validations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#policies" title="Policies" class="md-nav__link">
    Policies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preconditions" title="Preconditions" class="md-nav__link">
    Preconditions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validations" title="Validations" class="md-nav__link">
    Validations
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#context-validations" title="Context validations" class="md-nav__link">
    Context validations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exceptions-handling" title="Exceptions handling" class="md-nav__link">
    Exceptions handling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#i18n" title="I18n" class="md-nav__link">
    I18n
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generator" title="Generator" class="md-nav__link">
    Generator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/toptal/granite/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="granite-framework">Granite Framework<a class="headerlink" href="#granite-framework" title="Permanent link">&para;</a></h1>
<p>Granite is a business actions architecture for Rails apps.</p>
<p>It's a combination of user interaction (attributes and validations), context (preconditions) and
permissions (authorization policies).</p>
<h2 id="what-problems-it-solves">What problems it solves?<a class="headerlink" href="#what-problems-it-solves" title="Permanent link">&para;</a></h2>
<p>When your application becomes more prominent, you use patterns to allow you to
leverage your productivity. Instead of start inflating the controller and
model, you create a folder "app/managers" or something similar and start
pushing your business logic there.</p>
<p>These managers deals with a user wanting to perform some action interacting with the system.
The user needs to send some extra data to accomplish the task.
Some subject data is going to be managed during the action.</p>
<p>While implementing such actions, you have the choice if you want to introduce
validations and inflate the manager or keep the validations on the
controller. That can repeat in case multiple endpoints consume it.</p>
<h2 id="business-actions">Business actions<a class="headerlink" href="#business-actions" title="Permanent link">&para;</a></h2>
<p>The central concept of Granite is a business action. Each business action can
start from a simple <code>execute_perform!</code> method.</p>
<h3 id="hello-world">Hello world<a class="headerlink" href="#hello-world" title="Permanent link">&para;</a></h3>
<p>Basically it is an active model-like class (form object) defined to execute a sequence of commands.
The simplest business action looks like this:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Action</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="kp">private</span> <span class="k">def</span> <span class="nf">execute_perform!</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s1">&#39;Hello World&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>There are two ways of executing newly defined business action: using <code>#perform</code> or <code>#perform!</code> method:</p>
<div class="codehilite"><pre><span></span><span class="go">[1] pry(main)&gt; Action.new.perform!</span>
<span class="go">   (0.3ms)  BEGIN</span>
<span class="go">Hello World</span>
<span class="go">   (0.1ms)  COMMIT</span>
<span class="go">=&gt; true</span>
<span class="go">[2] pry(main)&gt; Action.new.perform</span>
<span class="go">   (0.2ms)  BEGIN</span>
<span class="go">Hello World</span>
<span class="go">   (0.2ms)  COMMIT</span>
<span class="go">=&gt; true</span>
</pre></div>


<p>As you can see from log, every action execution is wrapped inside a DB transaction.
The main difference between these methods is: <code>#perform!</code> raises exception in case of errors and <code>#perform</code> simply returns <code>false</code></p>
<h3 id="performer">Performer<a class="headerlink" href="#performer" title="Permanent link">&para;</a></h3>
<p>Every BA has a performer which can be assigned via <code>.as</code> class method before BA creation.</p>
<div class="codehilite"><pre><span></span><span class="no">MyAction</span><span class="o">.</span><span class="n">as</span><span class="p">(</span><span class="no">Admin</span><span class="o">.</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>


<p>Performer can be any Ruby object. By default performer is <code>nil</code>.</p>
<h3 id="attributes">Attributes<a class="headerlink" href="#attributes" title="Permanent link">&para;</a></h3>
<p>The next step is defining action attributes. There are several types of them and they are provided by <code>active_data</code> gem:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Action</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">collection</span> <span class="ss">:ids</span><span class="p">,</span> <span class="nb">Integer</span>

  <span class="kp">private</span> <span class="k">def</span> <span class="nf">execute_perform!</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">&quot;Hello </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">! We have the following ids: </span><span class="si">#{</span><span class="n">ids</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">  end</span>
<span class="s2">end</span>
</pre></div>


<p>For detailed information on the available types and usage examples, check out <a href="https://github.com/pyromaniac/active_data#attributes">ActiveData documentation</a>.</p>
<p>The attributes behave pretty much as they do with <code>ActiveData</code> objects, except for <code>represents</code>:</p>
<h4 id="represents">Represents<a class="headerlink" href="#represents" title="Permanent link">&para;</a></h4>
<p>In <code>ActiveData</code> objects, when a model attribute is exposed through <code>represents</code> and the AD object changes, the exposed attribute is updated right away, and Granite Actions update the represented attribute <code>before_validation</code>.</p>
<h3 id="associations">Associations<a class="headerlink" href="#associations" title="Permanent link">&para;</a></h3>
<p>Granite actions can also define several associations:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CreateBook</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">references_one</span> <span class="ss">:author</span>
  <span class="n">embeds_many</span> <span class="ss">:reviews</span>
<span class="k">end</span>
</pre></div>


<p>For more information on the associations available and usage examples, see <a href="https://github.com/pyromaniac/active_data#associations">ActiveData documentation</a>.</p>
<h3 id="nestedactions">NestedActions<a class="headerlink" href="#nestedactions" title="Permanent link">&para;</a></h3>
<p>Some business actions call other actions as part of their own action. For cases like that we should define memoizable method that
returns instance of subaction.</p>
<div class="codehilite"><pre><span></span><span class="n">memoize</span> <span class="k">def</span> <span class="nf">subaction</span>
  <span class="no">MySubactionClass</span><span class="o">.</span><span class="n">new</span>
<span class="k">end</span>
</pre></div>


<p>Subactions will validate their data and check preconditions when they're performed. This however should not be relied on
and it's better to check preconditions of subaction when precondtions of main action are checked and validate subaction
when main action is validated. For this we use:</p>
<div class="codehilite"><pre><span></span><span class="n">precondition</span> <span class="ss">embedded</span><span class="p">:</span> <span class="ss">:subaction</span>
<span class="n">validates</span> <span class="ss">:subaction</span><span class="p">,</span> <span class="ss">nested</span><span class="p">:</span> <span class="kp">true</span>
</pre></div>


<h3 id="subject">Subject<a class="headerlink" href="#subject" title="Permanent link">&para;</a></h3>
<p>Subject definition does three things: defines <code>references_one</code> association, aliases its methods
to common names (<code>subject</code> and <code>subject_id</code>) and modifies action initializer, providing ability to pass subject as the first
argument and restricting subject-less action initialization.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Action</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="n">subject</span> <span class="ss">:user</span>

  <span class="kp">private</span> <span class="k">def</span> <span class="nf">execute_perform!</span><span class="p">(</span><span class="o">*</span><span class="p">);</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="go">[1] pry(main)&gt; Action.new # =&gt; ArgumentError</span>
<span class="go">[2] pry(main)&gt; Action.new(User.first)</span>
<span class="go">=&gt; #&lt;Action user: #&lt;ReferencesOne #&lt;User id: 1...&gt;, user_id: 1&gt;</span>
<span class="go">[3] pry(main)&gt; Action.new(1)</span>
<span class="go">=&gt; #&lt;Action user: #&lt;ReferencesOne #&lt;User id: 1...&gt;, user_id: 1&gt;</span>
<span class="go">[4] pry(main)&gt; Action.new(user: User.first)</span>
<span class="go">=&gt; #&lt;Action user: #&lt;ReferencesOne #&lt;User id: 1...&gt;, user_id: 1&gt;</span>
<span class="go">[5] pry(main)&gt; Action.new(subject: User.first)</span>
<span class="go">=&gt; #&lt;Action user: #&lt;ReferencesOne #&lt;User id: 1...&gt;, user_id: 1&gt;</span>
<span class="go">[6] pry(main)&gt; Action.new(user_id: 1)</span>
<span class="go">=&gt; #&lt;Action user: #&lt;ReferencesOne #&lt;User id: 1...&gt;, user_id: 1&gt;</span>
<span class="go">[7] pry(main)&gt; Action.new(id: 1)</span>
<span class="go">=&gt; #&lt;Action user: #&lt;ReferencesOne #&lt;User id: 1...&gt;, user_id: 1&gt;</span>
</pre></div>


<p>As you can see <code>#user</code> is aliased to <code>#subject</code> and <code>#user_id</code> is aliased to <code>#id</code>. Also subject call takes any combination of <code>references_one</code> possible options.</p>
<h3 id="policies-preconditions-validations">Policies, preconditions, validations<a class="headerlink" href="#policies-preconditions-validations" title="Permanent link">&para;</a></h3>
<p>The main question is how to choose suitable construction. Here are simple rules:</p>
<ol>
<li>If condition is dependent on any of user provided attribute values except subject - it is a validation.</li>
<li>If condition depends on subject or any value found depending on subject - it is a precondition.</li>
<li>Otherwise if it is related to performer - it is a policy.</li>
</ol>
<h4 id="policies">Policies<a class="headerlink" href="#policies" title="Permanent link">&para;</a></h4>
<p>Performing restrictions for the performer:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Action</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="n">allow_if</span> <span class="p">{</span> <span class="n">performer</span><span class="o">.</span><span class="n">present?</span> <span class="p">}</span>
  <span class="n">allow_self</span> <span class="c1"># equal to allow_if { performer == subject }</span>
<span class="k">end</span>
</pre></div>


<p>Policies support strategies. If default <a href="./lib/granite/action/policies/any_strategy.rb">AnyStrategy</a> doesn't fit your needs
you can use <a href="./lib/granite/action/policies/always_allow_strategy.rb">AlwaysAllowStrategy</a>, <a href="./lib/granite/action/policies/required_performer_strategy.rb">RequiredPerformerStrategy</a>
or write your own. You can use new strategy like that:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Action</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">_policies_strategy</span> <span class="o">=</span> <span class="no">MyCustomStrategy</span>
<span class="k">end</span>
</pre></div>


<h4 id="preconditions">Preconditions<a class="headerlink" href="#preconditions" title="Permanent link">&para;</a></h4>
<p>This is a subject-related prevalidation, working in the same way as validations with blocks,
but <code>decline_with</code> method is used instead of <code>errors.add</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">precondition</span> <span class="k">do</span>
  <span class="n">decline_with</span><span class="p">(</span><span class="ss">:inactive</span><span class="p">)</span> <span class="k">unless</span> <span class="n">subject</span><span class="o">.</span><span class="n">active?</span>
<span class="k">end</span>
</pre></div>


<p>In case you have subactions which you perform inside your action you can
check subaction preconditions by simple embedding:</p>
<div class="codehilite"><pre><span></span><span class="n">precondition</span> <span class="ss">embedded</span><span class="p">:</span> <span class="ss">:my_custom_action</span>
</pre></div>


<p>You can specify conditions when precondition block should be executed with <code>:if</code> (and only <code>:if</code>) statement.</p>
<div class="codehilite"><pre><span></span><span class="n">precondition</span> <span class="k">if</span><span class="p">:</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">active?</span> <span class="p">}</span> <span class="k">do</span>
  <span class="n">decline_with</span><span class="p">(</span><span class="ss">:too_young</span><span class="p">)</span> <span class="k">if</span> <span class="n">subject</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">30</span>
<span class="k">end</span>
</pre></div>


<h4 id="validations">Validations<a class="headerlink" href="#validations" title="Permanent link">&para;</a></h4>
<p>You are able to use any of ActiveModel-provided validations.</p>
<h5 id="context-validations">Context validations<a class="headerlink" href="#context-validations" title="Permanent link">&para;</a></h5>
<p>Context validations (<a href="http://api.rubyonrails.org/classes/ActiveModel/Validations.html#method-i-valid-3F">see the note about the <code>context</code> argument</a>) are supported and embraced by Granite. You can specify the <code>on:</code> key with any validation to declare a context in which the validation should be executed. Such validations will be triggered only when the provided context was specified explicitly.</p>
<p>To specify a context with the built-in ActiveModel methods <code>valid?</code> and <code>invalid?</code>, simply provide the context as the first argument.</p>
<p>To specify a context with <code>perform</code>, <code>perform!</code>, or <code>try_perform!</code>, pass the name of the context as a keyword argument <code>context:</code>.</p>
<p>You should use context validations when a single action could be triggered in different scenarios (e.g. by a staff member and a user) and different validation behavior is required.</p>
<p>Consider this simplified business action for updating a portfolio of a user:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">BA</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">UpdatePortfolio</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="n">subject</span> <span class="ss">:user</span>

  <span class="n">represents</span> <span class="ss">:full_name</span><span class="p">,</span> <span class="ss">of</span><span class="p">:</span> <span class="ss">:subject</span>

  <span class="n">validates</span> <span class="ss">:full_name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">on</span><span class="p">:</span> <span class="ss">:user</span>

  <span class="kp">private</span> <span class="k">def</span> <span class="nf">execute_perform!</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>To run a business action without context you can simply send the <code>perform!</code> message to the action. It won't require full_name to be present.
If you want a validation to be executed in this scope you can add context argument to perform call: <code>perform!(context: :user)</code>.</p>
<h3 id="exceptions-handling">Exceptions handling<a class="headerlink" href="#exceptions-handling" title="Permanent link">&para;</a></h3>
<p>Granite has built-in mechanism for exceptions handling (similar to <code>rescue_from</code> known from <code>ActionController</code>). You are able to register handlers for any exception type, like this:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Action</span> <span class="o">&lt;</span> <span class="no">Granite</span><span class="o">::</span><span class="no">Action</span>
  <span class="n">handle_exception</span> <span class="no">ThirdPartyLib</span><span class="o">::</span><span class="no">APIError</span> <span class="k">do</span> <span class="o">|</span><span class="n">error</span><span class="o">|</span>
    <span class="n">decline_with</span><span class="p">(</span><span class="ss">:third_party_lib_failed</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span> <span class="k">def</span> <span class="nf">execute_perform!</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="no">ThirdPartyLib</span><span class="o">.</span><span class="n">api_call</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>Adding errors to action object is important, because each time handled exception is raised,
<code>Granite::Action::ValidationError</code> is raised.
Validation exception will have the same backtrace as original error.
Prefer this way over custom exception handling in private methods.</p>
<h3 id="i18n">I18n<a class="headerlink" href="#i18n" title="Permanent link">&para;</a></h3>
<p>There are special I18n rules working in action. If I18n identifier is prefixed with <code>.</code> (<code>t('.foobar')</code>) - then translations lookup happens in following order:</p>
<div class="codehilite"><pre><span></span>granite_action.#{granite_action_name}.foobar
granite_action.granite/action.foobar
foobar
</pre></div>


<p>Note that rules are different for <a href="#i18n-projectors-lookup">I18n lookup inside a projector context</a>.</p>
<h3 id="generator">Generator<a class="headerlink" href="#generator" title="Permanent link">&para;</a></h3>
<p>You can use granite generator to generate a starting point for your action. You have to pass name and path of action as first argument. Basic usage is:
<code>rails g granite SUBJECT/ACTION [PROJECTOR]</code>.
You can use <code>-C</code> or <code>--collection</code> option to generate collection action where subject is not known when initializing action.
You can pass a second argument to generator to specify projector name.</p>
<p><code>rails g granite user/create</code></p>
<div class="codehilite"><pre><span></span>  create  apq/actions/ba/user/create.rb
  create  apq/actions/ba/user/business_action.rb
  create  spec/apq/actions/ba/user/create_spec.rb
</pre></div>


<p><code>rails g granite user/create -C</code></p>
<div class="codehilite"><pre><span></span>  create  apq/actions/ba/user/create.rb
  create  spec/apq/actions/ba/user/create_spec.rb
</pre></div>


<p><code>rails g granite user/create simple</code></p>
<div class="codehilite"><pre><span></span>  create  apq/actions/ba/user/create/simple
  create  apq/actions/ba/user/create.rb
  create  apq/actions/ba/user/business_action.rb
  create  spec/apq/actions/ba/user/create_spec.rb
</pre></div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="projectors/" title="Projectors" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Projectors
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2013 - 2018 Toptal Team
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.1",url:{base:"."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-115649289-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>